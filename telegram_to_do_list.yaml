blueprint:
  name: Telegram To-do List
  description: >
    Manage a Home Assistant toâ€‘do list via Telegram.
    - Inline buttons to mark items done and switch views.
    - Reply keyboard with separate commands:
      ðŸ“œ Show list, ðŸ›’ Active only, ðŸ“œ Show all, ðŸ—‘ Clear completed, ðŸ”¥ Clear all.
    - Replyâ€‘keyboard commands are not added as items and are deleted from the chat.
    - Requires HA 2025.11+.
  domain: automation
  input:
    todo_entity:
      name: Toâ€‘do list
      description: Which toâ€‘do list entity to use
      selector:
        entity:
          domain: todo

    telegram_chat_id:
      name: Telegram chat_id
      description: Chat ID(s) (number or several, commaâ€‘separated) where the bot should send messages.
      selector:
        text:
          multiple: true

    list_command:
      name: List command
      description: Telegram command that opens the list (same as "ðŸ›’ Active only")
      default: "/list"
      selector:
        text: {}

    bot_config_entry_id:
      name: Bot Config Entry ID
      description: >
        Unique Config Entry ID of the Telegram bot.
      selector:
        text: {}

    last_message_id_helper:
      name: Helper to store message_id
      description: input_text or input_number that stores the last inline message_id
      selector:
        entity:
          domain:
            - input_text
            - input_number

mode: queued
max: 5

variables:
  todo_entity: !input todo_entity
  telegram_chat_ids: !input telegram_chat_id
  list_command: !input list_command
  bot_config_id: !input bot_config_entry_id
  last_message_id_helper: !input last_message_id_helper

trigger:
  - platform: event
    event_type: telegram_command
  - platform: event
    event_type: telegram_callback
  - platform: event
    event_type: telegram_text

condition:
  - condition: template
    value_template: >
      {{ trigger.event.data.bot.config_entry_id == bot_config_id
         and (trigger.event.data.chat_id | string) in telegram_chat_ids }}

action:
  # ----------------------------------------------------------------
  # 0. Command /kb â€” initialize reply keyboard
  # ----------------------------------------------------------------
  - choose:
      - conditions:
          - condition: template
            value_template: >
              {{ trigger.event.event_type == 'telegram_command'
                 and trigger.event.data.command == '/kb' }}
        sequence:
          - action: telegram_bot.send_message
            continue_on_error: true
            data:
              config_entry_id: "{{ bot_config_id }}"
              target: "{{ trigger.event.data.chat_id }}"
              keyboard:
                - 'ðŸ“œ Show list'
                - 'ðŸ›’ Active only'
                - 'ðŸ“œ Show all'
                - 'ðŸ—‘ Clear completed'
                - 'ðŸ”¥ Clear all'
              message: "Keyboard activated âœ…"

  - choose:
      # ----------------------------------------------------------------
      # 1. /list command (same as "ðŸ›’ Active only")
      # ----------------------------------------------------------------
      - conditions:
          - condition: template
            value_template: >
              {{ trigger.event.event_type == 'telegram_command'
                 and trigger.event.data.command == list_command }}
        sequence:
          - action: todo.get_items
            target:
              entity_id: "{{ todo_entity }}"
            data:
              status: ['needs_action']
            response_variable: todo_resp

          - variables:
              items: "{{ todo_resp[todo_entity]['items'] | default([]) }}"
              header_text: >
                {% if items | length == 0 %}
                  List is empty ðŸ¤·â€â™‚ï¸
                {% else %}
                  Your shopping list:
                {% endif %}
              list_keyboard: >
                {% set ns = namespace(rows=[]) %}
                {% for item in items %}
                  {% set btn = 'âœ… ' ~ item.summary ~ ':/done_' ~ item.uid %}
                  {% set ns.rows = ns.rows + [btn] %}
                {% endfor %}
                {% set ns.rows = ns.rows + ['ðŸ“œ Show all:/toggle_mode_all'] %}
                {% set ns.rows = ns.rows + ['ðŸ—‘ Clear completed:/clear_completed'] %}
                {{ ns.rows }}

          - action: telegram_bot.send_message
            continue_on_error: true
            data:
              config_entry_id: "{{ bot_config_id }}"
              target: "{{ trigger.event.data.chat_id }}"
              message: "{{ header_text }}"
              inline_keyboard: "{{ list_keyboard }}"
            response_variable: send_resp

          - variables:
              last_msg_id: "{{ send_resp['message_id'] | default(send_resp.message_id) }}"
          
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ last_message_id_helper.startswith('input_text.') }}"
                sequence:
                  - action: input_text.set_value
                    target:
                      entity_id: "{{ last_message_id_helper }}"
                    data:
                      value: "{{ last_msg_id }}"
            default:
              - action: input_number.set_value
                target:
                  entity_id: "{{ last_message_id_helper }}"
                data:
                  value: "{{ last_msg_id | int(0) }}"

      # ----------------------------------------------------------------
      # 2. Free text -> Add items (NOT commands)
      # ----------------------------------------------------------------
      - conditions:
          - condition: template
            value_template: >
              {% set t = trigger.event.data.text | default('') | trim %}
              {{ trigger.event.event_type == 'telegram_text'
                 and not t.startswith('/')
                 and t not in [
                   'ðŸ“œ Show list',
                   'ðŸ›’ Active only',
                   'ðŸ“œ Show all',
                   'ðŸ—‘ Clear completed',
                   'ðŸ”¥ Clear all'
                 ] }}
        sequence:
          - action: todo.get_items
            target:
              entity_id: "{{ todo_entity }}"
            data:
              status: ['needs_action']
            response_variable: current_todo

          - variables:
              existing_names: >
                {{ current_todo[todo_entity]['items'] | map(attribute='summary') | map('lower') | list }}
              raw_text: "{{ trigger.event.data.text | default('') }}"
              candidates: >
                {% set parts = raw_text.split(',') %}
                {{ parts | map('trim') | select('!=', '') | list }}
              items_to_add: >
                {% set ns = namespace(final=[]) %}
                {% for cand in candidates %}
                  {% if cand | lower not in existing_names %}
                    {% set ns.final = ns.final + [cand] %}
                  {% endif %}
                {% endfor %}
                {{ ns.final }}

          - repeat:
              for_each: "{{ items_to_add }}"
              sequence:
                - action: todo.add_item
                  target:
                    entity_id: "{{ todo_entity }}"
                  data:
                    item: "{{ repeat.item }}"

          - action: todo.get_items
            target:
              entity_id: "{{ todo_entity }}"
            data:
              status: ['needs_action']
            response_variable: todo_resp_new

          - variables:
              items_new: "{{ todo_resp_new[todo_entity]['items'] | default([]) }}"
              header_text_new: >
                {% if items_new | length == 0 %}
                  List is empty ðŸ¤·â€â™‚ï¸
                {% else %}
                  Your shopping list:
                {% endif %}
              list_keyboard_new: >
                {% set ns = namespace(rows=[]) %}
                {% for item in items_new %}
                  {% set btn = 'âœ… ' ~ item.summary ~ ':/done_' ~ item.uid %}
                  {% set ns.rows = ns.rows + [btn] %}
                {% endfor %}
                {% set ns.rows = ns.rows + ['ðŸ“œ Show all:/toggle_mode_all'] %}
                {% set ns.rows = ns.rows + ['ðŸ—‘ Clear completed:/clear_completed'] %}
                {{ ns.rows }}
              last_msg_id_val: >
                {% if last_message_id_helper.startswith('input_text.') %}
                  {{ states(last_message_id_helper) }}
                {% else %}
                  {{ states(last_message_id_helper) | int(0) }}
                {% endif %}

          - choose:
              - conditions:
                  - condition: template
                    value_template: >
                      {{ last_msg_id_val not in ['', '0', 'unknown', 'unavailable', None] }}
                sequence:
                  - action: telegram_bot.edit_message
                    continue_on_error: true
                    data:
                      config_entry_id: "{{ bot_config_id }}"
                      chat_id: "{{ trigger.event.data.chat_id }}"
                      message_id: "{{ last_msg_id_val | int }}"
                      message: "{{ header_text_new }}"
                      inline_keyboard: "{{ list_keyboard_new }}"
            default:
              - action: telegram_bot.send_message
                continue_on_error: true
                data:
                  config_entry_id: "{{ bot_config_id }}"
                  target: "{{ trigger.event.data.chat_id }}"
                  message: "{{ header_text_new }}"
                  inline_keyboard: "{{ list_keyboard_new }}"
                response_variable: send_resp_new
              
              - variables:
                  new_id: "{{ send_resp_new['message_id'] | default(send_resp_new.message_id) }}"
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ last_message_id_helper.startswith('input_text.') }}"
                    sequence:
                      - action: input_text.set_value
                        target:
                          entity_id: "{{ last_message_id_helper }}"
                        data:
                          value: "{{ new_id }}"
                default:
                  - action: input_number.set_value
                    target:
                      entity_id: "{{ last_message_id_helper }}"
                    data:
                      value: "{{ new_id | int(0) }}"

      # ----------------------------------------------------------------
      # 3. Replyâ€‘keyboard commands (delete message + perform action)
      # ----------------------------------------------------------------
      - conditions:
          - condition: template
            value_template: >
              {{ trigger.event.event_type == 'telegram_text'
                 and (trigger.event.data.text | default('') | trim) in [
                   'ðŸ“œ Show list',
                   'ðŸ›’ Active only',
                   'ðŸ“œ Show all',
                   'ðŸ—‘ Clear completed',
                   'ðŸ”¥ Clear all'
                 ] }}
        sequence:
          - variables:
              text: "{{ trigger.event.data.text | default('') | trim }}"
              chat_id: "{{ trigger.event.data.chat_id | default(0) }}"
              msg_id_raw: >
                {% if trigger.event.data.message is defined and trigger.event.data.message is not none
                      and trigger.event.data.message.message_id is defined %}
                  {{ trigger.event.data.message.message_id }}
                {% elif trigger.event.data.message_id is defined %}
                  {{ trigger.event.data.message_id }}
                {% else %}
                  0
                {% endif %}
              msg_id: "{{ msg_id_raw | int(0) }}"

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ msg_id > 0 }}"
                sequence:
                  - action: telegram_bot.delete_message
                    continue_on_error: true
                    data:
                      chat_id: "{{ chat_id }}"
                      message_id: "{{ msg_id }}"

          - choose:
              # ðŸ“œ Show list / ðŸ›’ Active only â€” show active items
              - conditions:
                  - condition: template
                    value_template: "{{ text == 'ðŸ“œ Show list' or text == 'ðŸ›’ Active only' }}"
                sequence:
                  - action: todo.get_items
                    target:
                      entity_id: "{{ todo_entity }}"
                    data:
                      status: ['needs_action']
                    response_variable: todo_resp_cmd

                  - variables:
                      items_cmd: "{{ todo_resp_cmd[todo_entity]['items'] | default([]) }}"
                      header_cmd: >
                        {% if items_cmd | length == 0 %}
                          List is empty ðŸ¤·â€â™‚ï¸
                        {% else %}
                          Your shopping list:
                        {% endif %}
                      kb_cmd: >
                        {% set ns = namespace(rows=[]) %}
                        {% for item in items_cmd %}
                          {% set btn = 'âœ… ' ~ item.summary ~ ':/done_' ~ item.uid %}
                          {% set ns.rows = ns.rows + [btn] %}
                        {% endfor %}
                        {% set ns.rows = ns.rows + ['ðŸ“œ Show all:/toggle_mode_all'] %}
                        {% set ns.rows = ns.rows + ['ðŸ—‘ Clear completed:/clear_completed'] %}
                        {{ ns.rows }}

                  - action: telegram_bot.send_message
                    continue_on_error: true
                    data:
                      config_entry_id: "{{ bot_config_id }}"
                      target: "{{ trigger.event.data.chat_id }}"
                      message: "{{ header_cmd }}"
                      inline_keyboard: "{{ kb_cmd }}"
                    response_variable: send_resp_cmd

                  - variables:
                      last_msg_id2: "{{ send_resp_cmd['message_id'] | default(send_resp_cmd.message_id) }}"
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ last_message_id_helper.startswith('input_text.') }}"
                        sequence:
                          - action: input_text.set_value
                            target:
                              entity_id: "{{ last_message_id_helper }}"
                            data:
                              value: "{{ last_msg_id2 }}"
                    default:
                      - action: input_number.set_value
                        target:
                          entity_id: "{{ last_message_id_helper }}"
                        data:
                          value: "{{ last_msg_id2 | int(0) }}"

              # ðŸ“œ Show all â€” show all items
              - conditions:
                  - condition: template
                    value_template: "{{ text == 'ðŸ“œ Show all' }}"
                sequence:
                  - action: todo.get_items
                    target:
                      entity_id: "{{ todo_entity }}"
                    response_variable: todo_resp_all_cmd
                  - variables:
                      items_all: "{{ todo_resp_all_cmd[todo_entity]['items'] | default([]) }}"
                      header_all: >
                        {% if items_all | length == 0 %}
                          List is empty ðŸ¤·â€â™‚ï¸
                        {% else %}
                          History (all items):
                        {% endif %}
                      kb_all: >
                        {% set ns = namespace(rows=[]) %}
                        {% for item in items_all %}
                          {% if item.status == 'needs_action' %}
                            {% set btn = 'âœ… ' ~ item.summary ~ ':/done_' ~ item.uid %}
                          {% else %}
                            {% set btn = 'â˜‘ï¸ ' ~ item.summary ~ ':/reopen_' ~ item.uid %}
                          {% endif %}
                          {% set ns.rows = ns.rows + [btn] %}
                        {% endfor %}
                        {% set ns.rows = ns.rows + ['ðŸ—‘ Clear completed:/clear_completed'] %}
                        {{ ns.rows }}

                  - action: telegram_bot.send_message
                    continue_on_error: true
                    data:
                      config_entry_id: "{{ bot_config_id }}"
                      target: "{{ trigger.event.data.chat_id }}"
                      message: "{{ header_all }}"
                      inline_keyboard: "{{ kb_all }}"

              # ðŸ—‘ Clear completed
              - conditions:
                  - condition: template
                    value_template: "{{ text == 'ðŸ—‘ Clear completed' }}"
                sequence:
                  - action: todo.remove_completed_items
                    target:
                      entity_id: "{{ todo_entity }}"
                  - action: telegram_bot.send_message
                    continue_on_error: true
                    data:
                      config_entry_id: "{{ bot_config_id }}"
                      target: "{{ trigger.event.data.chat_id }}"
                      message: "âœ… Completed items cleared."

              # ðŸ”¥ Clear all
              - conditions:
                  - condition: template
                    value_template: "{{ text == 'ðŸ”¥ Clear all' }}"
                sequence:
                  - action: todo.get_items
                    target:
                      entity_id: "{{ todo_entity }}"
                    response_variable: all_items_cmd
                  - repeat:
                      for_each: "{{ all_items_cmd[todo_entity]['items'] }}"
                      sequence:
                        - action: todo.remove_item
                          target:
                            entity_id: "{{ todo_entity }}"
                          data:
                            item: "{{ repeat.item.uid }}"
                  - action: telegram_bot.send_message
                    continue_on_error: true
                    data:
                      config_entry_id: "{{ bot_config_id }}"
                      target: "{{ trigger.event.data.chat_id }}"
                      message: "ðŸ”¥ Entire list cleared."

      # ----------------------------------------------------------------
      # 4. Callback (inline buttons)
      # ----------------------------------------------------------------
      - conditions:
          - condition: template
            value_template: >
              {{ trigger.event.event_type == 'telegram_callback' }}
        sequence:
          - variables:
              data: "{{ trigger.event.data.data | default('') }}"
              is_done: "{{ data.startswith('/done_') }}"
              is_reopen: "{{ data.startswith('/reopen_') }}"
              is_clear: "{{ data == '/clear_completed' }}"
              is_toggle_active: "{{ data == '/toggle_mode_active' }}"
              is_toggle_all: "{{ data == '/toggle_mode_all' }}"
              
              show_mode: >
                {% if is_toggle_all %}all
                {% elif is_toggle_active %}active
                {% else %}active{% endif %}
              
              current_msg_id: "{{ trigger.event.data.message.message_id }}"
              chat_id: "{{ trigger.event.data.chat_id }}"

          - if:
              - condition: template
                value_template: "{{ is_clear }}"
            then:
              - action: todo.remove_completed_items
                target:
                  entity_id: "{{ todo_entity }}"

          - if:
              - condition: template
                value_template: "{{ is_done }}"
            then:
              - variables:
                  uid: "{{ data.split('_', 1)[1] }}"
              - action: todo.update_item
                target:
                  entity_id: "{{ todo_entity }}"
                data:
                  item: "{{ uid }}"
                  status: "completed"

          - if:
              - condition: template
                value_template: "{{ is_reopen }}"
            then:
              - variables:
                  uid: "{{ data.split('_', 1)[1] }}"
              - action: todo.update_item
                target:
                  entity_id: "{{ todo_entity }}"
                data:
                  item: "{{ uid }}"
                  status: "needs_action"

          - action: todo.get_items
            target:
              entity_id: "{{ todo_entity }}"
            response_variable: todo_resp_cb

          - variables:
              items_raw: "{{ todo_resp_cb[todo_entity]['items'] | default([]) }}"
              items: >
                {% if show_mode == 'active' %}
                  {{ items_raw | selectattr('status', 'eq', 'needs_action') | list }}
                {% else %}
                  {{ items_raw }}
                {% endif %}
              header_text_cb: >
                {% if items | length == 0 %}
                  List is empty ðŸ¤·â€â™‚ï¸
                {% else %}
                  {% if show_mode == 'active' %}Your shopping list:{% else %}History (all items):{% endif %}
                {% endif %}
              keyboard_cb: >
                {% set ns = namespace(rows=[]) %}
                {% for item in items %}
                  {% if item.status == 'needs_action' %}
                    {% set btn = 'âœ… ' ~ item.summary ~ ':/done_' ~ item.uid %}
                    {% set ns.rows = ns.rows + [btn] %}
                  {% else %}
                    {% set btn = 'â˜‘ï¸ ' ~ item.summary ~ ':/reopen_' ~ item.uid %}
                    {% set ns.rows = ns.rows + [btn] %}
                  {% endif %}
                {% endfor %}
                {% set toggle_str = '' %}
                {% if show_mode == 'active' %}
                  {% set toggle_str = 'ðŸ“œ Show all:/toggle_mode_all' %}
                {% else %}
                  {% set toggle_str = 'ðŸ›’ Active only:/toggle_mode_active' %}
                {% endif %}
                {% set ns.rows = ns.rows + [toggle_str] %}
                {% set ns.rows = ns.rows + ['ðŸ—‘ Clear completed:/clear_completed'] %}
                {{ ns.rows }}

          - action: telegram_bot.edit_message
            continue_on_error: true
            data:
              config_entry_id: "{{ bot_config_id }}"
              chat_id: "{{ chat_id }}"
              message_id: "{{ current_msg_id }}"
              message: "{{ header_text_cb }}"
              inline_keyboard: "{{ keyboard_cb }}"

          - action: telegram_bot.answer_callback_query
            continue_on_error: true
            data:
              config_entry_id: "{{ bot_config_id }}"
              callback_query_id: "{{ trigger.event.data.id }}"
              message: >
                {% if is_done %}Done{% elif is_reopen %}Active again{% elif is_clear %}Cleared{% else %}Updated{% endif %}
