blueprint:
  name: Telegram To-do List (EN)
  description: >
    Telegram-based To-do list for Home Assistant:
    - Inline buttons with edit_message
    - Active / All toggle (only if completed items exist)
    - Dynamic Clear button
    - Duplicate protection
    - Reopen completed items
    - Multi-item input via "," or "."
    - HA 2025.12+
  domain: automation

  input:
    todo_entity:
      name: To-do list
      selector:
        entity:
          domain: todo

    telegram_chat_id:
      name: Telegram chat_id
      selector:
        number:

    bot_config_entry_id:
      name: Telegram bot Config Entry ID
      selector:
        text:

mode: restart
max_exceeded: silent

variables:
  todo_entity: !input todo_entity
  chat_id: !input telegram_chat_id
  bot_id: !input bot_config_entry_id

trigger:
  - platform: event
    event_type: telegram_command
  - platform: event
    event_type: telegram_text
  - platform: event
    event_type: telegram_callback

condition:
  - condition: template
    value_template: >
      {{ trigger.event.data.chat_id | int == chat_id | int }}

action:
  - choose:

      ############################################################
      # /start and /list â€” show active items
      ############################################################
      - conditions:
          - condition: template
            value_template: >
              {{ trigger.event.event_type == 'telegram_command'
                 and trigger.event.data.command in ['/start','/list'] }}
        sequence:
          - action: todo.get_items
            target:
              entity_id: "{{ todo_entity }}"
            response_variable: todo_resp

          - variables:
              items: >
                {{ todo_resp[todo_entity]['items']
                   | selectattr('status','eq','needs_action')
                   | list }}
              has_completed: >
                {{ todo_resp[todo_entity]['items']
                   | selectattr('status','eq','completed')
                   | list | length > 0 }}
              text: >
                {% if items | length == 0 %}
                  ğŸ›’ Your list is empty ğŸ¤·â€â™‚ï¸
                {% else %}
                  ğŸ›’ Shopping list:
                {% endif %}
              keyboard: >
                {% set r = namespace(v=[]) %}
                {% for i in items %}
                  {% set r.v = r.v + [[['âœ… ' ~ i.summary, '/done_' ~ i.uid]]] %}
                {% endfor %}
                {% if has_completed %}
                  {% set r.v = r.v + [[['ğŸ“‚ Show all','/show_all']]] %}
                {% endif %}
                {{ r.v }}

          - action: telegram_bot.send_message
            data:
              config_entry_id: "{{ bot_id }}"
              target: "{{ chat_id }}"
              message: "{{ text }}"
              inline_keyboard: "{{ keyboard }}"
              keyboard:
                - "ğŸ“‹ Show list"
                - "ğŸ—‘ Clear completed"
              resize_keyboard: true
              one_time_keyboard: false

      ############################################################
      # REPLY: ğŸ“‹ Show list
      ############################################################
      - conditions:
          - condition: template
            value_template: >
              {{ trigger.event.event_type == 'telegram_text'
                 and trigger.event.data.text == 'ğŸ“‹ Show list' }}
        sequence:
          - action: todo.get_items
            target:
              entity_id: "{{ todo_entity }}"
            response_variable: todo_resp

          - variables:
              items: >
                {{ todo_resp[todo_entity]['items']
                   | selectattr('status','eq','needs_action')
                   | list }}
              has_completed: >
                {{ todo_resp[todo_entity]['items']
                   | selectattr('status','eq','completed')
                   | list | length > 0 }}
              text: >
                {% if items | length == 0 %}
                  ğŸ›’ Your list is empty ğŸ¤·â€â™‚ï¸
                {% else %}
                  ğŸ›’ Shopping list:
                {% endif %}
              keyboard: >
                {% set r = namespace(v=[]) %}
                {% for i in items %}
                  {% set r.v = r.v + [[['âœ… ' ~ i.summary, '/done_' ~ i.uid]]] %}
                {% endfor %}
                {% if has_completed %}
                  {% set r.v = r.v + [[['ğŸ“‚ Show all','/show_all']]] %}
                {% endif %}
                {{ r.v }}

          - action: telegram_bot.send_message
            data:
              config_entry_id: "{{ bot_id }}"
              target: "{{ chat_id }}"
              message: "{{ text }}"
              inline_keyboard: "{{ keyboard }}"

      ############################################################
      # REPLY: ğŸ—‘ Clear completed
      ############################################################
      - conditions:
          - condition: template
            value_template: >
              {{ trigger.event.event_type == 'telegram_text'
                 and trigger.event.data.text == 'ğŸ—‘ Clear completed' }}
        sequence:
          - action: todo.remove_completed_items
            target:
              entity_id: "{{ todo_entity }}"

          - action: telegram_bot.send_message
            data:
              config_entry_id: "{{ bot_id }}"
              target: "{{ chat_id }}"
              message: "ğŸ—‘ Completed items removed"

      ############################################################
      # Add items via text (multi + duplicate protection)
      ############################################################
      - conditions:
          - condition: template
            value_template: >
              {{ trigger.event.event_type == 'telegram_text'
                 and trigger.event.data.text not in [
                   'ğŸ“‹ Show list',
                   'ğŸ—‘ Clear completed'
                 ]
                 and not (trigger.event.data.text | trim).startswith('/') }}
        sequence:
          - variables:
              raw_text: "{{ trigger.event.data.text }}"
              candidates: >
                {% set parts = raw_text.replace('.', ',').split(',') %}
                {{ parts | map('trim') | reject('equalto','') | list }}

          - action: todo.get_items
            target:
              entity_id: "{{ todo_entity }}"
            response_variable: current

          - repeat:
              for_each: "{{ candidates }}"
              sequence:
                - variables:
                    raw: "{{ repeat.item }}"
                    new_item: "{{ repeat.item | lower | replace(' ','') }}"

                - variables:
                    active_norm: >
                      {{ current[todo_entity]['items']
                         | selectattr('status','eq','needs_action')
                         | map(attribute='summary')
                         | map('lower')
                         | map('replace',' ','')
                         | list }}
                    completed_norm: >
                      {{ current[todo_entity]['items']
                         | selectattr('status','eq','completed')
                         | map(attribute='summary')
                         | map('lower')
                         | map('replace',' ','')
                         | list }}

                - choose:
                    - conditions:
                        - condition: template
                          value_template: "{{ new_item in active_norm }}"
                      sequence:
                        - action: telegram_bot.send_message
                          data:
                            config_entry_id: "{{ bot_id }}"
                            target: "{{ chat_id }}"
                            message: "âš ï¸ Item â€œ{{ raw }}â€ already exists"

                    - conditions:
                        - condition: template
                          value_template: "{{ new_item in completed_norm }}"
                      sequence:
                        - variables:
                            idx: "{{ completed_norm.index(new_item) }}"
                            uid: "{{ current[todo_entity]['items']
                                     | selectattr('status','eq','completed')
                                     | list
                                     | map(attribute='uid')
                                     | list
                                     | nth(idx) }}"
                        - action: todo.update_item
                          target:
                            entity_id: "{{ todo_entity }}"
                          data:
                            item: "{{ uid }}"
                            status: needs_action

                    - conditions:
                        - condition: template
                          value_template: >
                            {{ new_item not in active_norm
                               and new_item not in completed_norm }}
                      sequence:
                        - action: todo.add_item
                          target:
                            entity_id: "{{ todo_entity }}"
                          data:
                            item: "{{ raw }}"

      ############################################################
      # Inline buttons â€” UI (edit_message)
      ############################################################
      - conditions:
          - condition: template
            value_template: "{{ trigger.event.event_type == 'telegram_callback' }}"
        sequence:
          - variables:
              cb: "{{ trigger.event.data.data }}"
              msg_id: "{{ trigger.event.data.message.message_id }}"

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ cb.startswith('/done_') }}"
                sequence:
                  - action: todo.update_item
                    target:
                      entity_id: "{{ todo_entity }}"
                    data:
                      item: "{{ cb.split('_',1)[1] }}"
                      status: completed

              - conditions:
                  - condition: template
                    value_template: "{{ cb.startswith('/reopen_') }}"
                sequence:
                  - action: todo.update_item
                    target:
                      entity_id: "{{ todo_entity }}"
                    data:
                      item: "{{ cb.split('_',1)[1] }}"
                      status: needs_action

              - conditions:
                  - condition: template
                    value_template: "{{ cb == '/clear_completed' }}"
                sequence:
                  - action: todo.remove_completed_items
                    target:
                      entity_id: "{{ todo_entity }}"

          - action: todo.get_items
            target:
              entity_id: "{{ todo_entity }}"
            response_variable: todo_resp

          - variables:
              items_all: "{{ todo_resp[todo_entity]['items'] | default([]) }}"
              has_completed: >
                {{ items_all
                   | selectattr('status','eq','completed')
                   | list | length > 0 }}
              mode: >
                {% if cb == '/show_all' %}all{% else %}active{% endif %}
              items: >
                {% if mode == 'all' %}
                  {{ items_all }}
                {% else %}
                  {{ items_all
                     | selectattr('status','eq','needs_action')
                     | list }}
                {% endif %}
              text: >
                {% if items | length == 0 %}
                  ğŸ›’ Your list is empty ğŸ¤·â€â™‚ï¸
                {% else %}
                  ğŸ›’ Shopping list:
                {% endif %}
              keyboard: >
                {% set r = namespace(v=[]) %}
                {% for i in items %}
                  {% if i.status == 'needs_action' %}
                    {% set r.v = r.v + [[['âœ… ' ~ i.summary, '/done_' ~ i.uid]]] %}
                  {% else %}
                    {% set r.v = r.v + [[['â˜‘ï¸ ' ~ i.summary, '/reopen_' ~ i.uid]]] %}
                  {% endif %}
                {% endfor %}
                {% if has_completed %}
                  {% if mode == 'active' %}
                    {% set r.v = r.v + [[['ğŸ“‚ Show all','/show_all']]] %}
                  {% else %}
                    {% set r.v = r.v + [[['ğŸ›’ Active','/show_active']]] %}
                  {% endif %}
                  {% set r.v = r.v + [[['ğŸ—‘ Clear completed','/clear_completed']]] %}
                {% endif %}
                {{ r.v }}

          - action: telegram_bot.edit_message
            data:
              config_entry_id: "{{ bot_id }}"
              chat_id: "{{ chat_id }}"
              message_id: "{{ msg_id }}"
              message: "{{ text }}"
              inline_keyboard: "{{ keyboard }}"

          - action: telegram_bot.answer_callback_query
            data:
              config_entry_id: "{{ bot_id }}"
              callback_query_id: "{{ trigger.event.data.id }}"
              message: "Done"
