blueprint:
  name: Telegram To-do List(ru)
  description: >
    –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–º –ø–æ–∫—É–ø–æ–∫ (To-do) —á–µ—Ä–µ–∑ Telegram.
    - Inline-–∫–Ω–æ–ø–∫–∏ –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ –∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è.
    - Reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏:
      üìú –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫, üõí –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ, üìú –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ, üóë –û—á–∏—Å—Ç–∏—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ, üî• –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë.
    - –ö–æ–º–∞–Ω–¥—ã –∏–∑ Reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –Ω–µ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ —Å–ø–∏—Å–æ–∫ –∏ —É–¥–∞–ª—è—é—Ç—Å—è –∏–∑ —á–∞—Ç–∞.
    - –î–ª—è HA 2025.11+
  domain: automation
  input:
    todo_entity:
      name: To-do —Å–ø–∏—Å–æ–∫
      description: –ö–∞–∫–æ–π To-do list –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
      selector:
        entity:
          domain: todo

    telegram_chat_id:
      name: Telegram chat_id
      description: ID —á–∞—Ç–∞ (—á–∏—Å–ª–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é), –∫—É–¥–∞ —Å–ª–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è.
      selector:
        text:
          multiple: true

    list_command:
      name: –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Å–ø–∏—Å–∫–∞
      description: Telegram-–∫–æ–º–∞–Ω–¥–∞, –æ—Ç–∫—Ä—ã–≤–∞—é—â–∞—è —Å–ø–∏—Å–æ–∫
      default: "/list"
      selector:
        text: {}

    bot_config_entry_id:
      name: Config Entry ID –±–æ—Ç–∞
      description: >
        –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞.
      selector:
        text: {}

    last_message_id_helper:
      name: Helper –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è message_id
      description: input_text –∏–ª–∏ input_number –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è ID –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
      selector:
        entity:
          domain:
            - input_text
            - input_number

mode: restart
max_exceeded: silent

variables:
  todo_entity: !input todo_entity
  telegram_chat_ids: !input telegram_chat_id
  list_command: !input list_command
  bot_config_id: !input bot_config_entry_id
  last_message_id_helper: !input last_message_id_helper

trigger:
  - platform: event
    event_type: telegram_command
  - platform: event
    event_type: telegram_callback
  - platform: event
    event_type: telegram_text

condition:
  - condition: template
    value_template: >
      {{ trigger.event.data.bot.config_entry_id == bot_config_id 
         and trigger.event.data.chat_id | string in telegram_chat_ids }}

action:
  - choose:
      # ----------------------------------------------------------------
      # 1. –ö–æ–º–∞–Ω–¥–∞ /list (—Ç–æ –∂–µ, —á—Ç–æ "üõí –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ")
      # ----------------------------------------------------------------
      - conditions:
          - condition: template
            value_template: >
              {{ trigger.event.event_type == 'telegram_command'
                 and trigger.event.data.command == list_command }}
        sequence:
          - action: todo.get_items
            target:
              entity_id: "{{ todo_entity }}"
            data:
              status: ['needs_action']
            response_variable: todo_resp

          - variables:
              items: "{{ todo_resp[todo_entity]['items'] | default([]) }}"
              header_text: >
                {% if items | length == 0 %}
                  –°–ø–∏—Å–æ–∫ –ø—É—Å—Ç ü§∑‚Äç‚ôÇÔ∏è
                {% else %}
                  –í–∞—à —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫:
                {% endif %}
              list_keyboard: >
                {% set ns = namespace(rows=[]) %}
                {% for item in items %}
                  {% set btn = '‚úÖ ' ~ item.summary ~ ':/done_' ~ item.uid %}
                  {% set ns.rows = ns.rows + [btn] %}
                {% endfor %}
                {% set ns.rows = ns.rows + ['üìú –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ:/toggle_mode_all'] %}
                {% set ns.rows = ns.rows + ['üóë –û—á–∏—Å—Ç–∏—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ:/clear_completed'] %}
                {{ ns.rows }}

          - action: telegram_bot.send_message
            data:
              config_entry_id: "{{ bot_config_id }}"
              target: "{{ trigger.event.data.chat_id }}"
              message: "{{ header_text }}"
              inline_keyboard: "{{ list_keyboard }}"
            response_variable: send_resp

          - variables:
              last_msg_id: "{{ send_resp['message_id'] | default(send_resp.message_id) }}"
          
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ last_message_id_helper.startswith('input_text.') }}"
                sequence:
                  - action: input_text.set_value
                    target:
                      entity_id: "{{ last_message_id_helper }}"
                    data:
                      value: "{{ last_msg_id }}"
            default:
              - action: input_number.set_value
                target:
                  entity_id: "{{ last_message_id_helper }}"
                data:
                  value: "{{ last_msg_id | int(0) }}"

      # ----------------------------------------------------------------
      # 2. –¢–µ–∫—Å—Ç -> –î–æ–±–∞–≤–∏—Ç—å (–ù–ï –∫–æ–º–∞–Ω–¥—ã)
      # ----------------------------------------------------------------
      - conditions:
          - condition: template
            value_template: >
              {% set t = trigger.event.data.text | default('') | trim %}
              {{ trigger.event.event_type == 'telegram_text'
                 and not t.startswith('/')
                 and t not in [
                   'üìú –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫',
                   'üõí –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ',
                   'üìú –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ',
                   'üóë –û—á–∏—Å—Ç–∏—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ',
                   'üî• –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë'
                 ] }}
        sequence:
          - action: todo.get_items
            target:
              entity_id: "{{ todo_entity }}"
            data:
              status: ['needs_action']
            response_variable: current_todo

          - variables:
              existing_names: >
                {{ current_todo[todo_entity]['items'] | map(attribute='summary') | map('lower') | list }}
              raw_text: "{{ trigger.event.data.text | default('') }}"
              candidates: >
                {% set parts = raw_text.split(',') %}
                {{ parts | map('trim') | select('!=', '') | list }}
              items_to_add: >
                {% set ns = namespace(final=[]) %}
                {% for cand in candidates %}
                  {% if cand | lower not in existing_names %}
                    {% set ns.final = ns.final + [cand] %}
                  {% endif %}
                {% endfor %}
                {{ ns.final }}

          - repeat:
              for_each: "{{ items_to_add }}"
              sequence:
                - action: todo.add_item
                  target:
                    entity_id: "{{ todo_entity }}"
                  data:
                    item: "{{ repeat.item }}"

          - action: todo.get_items
            target:
              entity_id: "{{ todo_entity }}"
            data:
              status: ['needs_action']
            response_variable: todo_resp_new

          - variables:
              items_new: "{{ todo_resp_new[todo_entity]['items'] | default([]) }}"
              header_text_new: >
                {% if items_new | length == 0 %}
                  –°–ø–∏—Å–æ–∫ –ø—É—Å—Ç ü§∑‚Äç‚ôÇÔ∏è
                {% else %}
                  –í–∞—à —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫:
                {% endif %}
              list_keyboard_new: >
                {% set ns = namespace(rows=[]) %}
                {% for item in items_new %}
                  {% set btn = '‚úÖ ' ~ item.summary ~ ':/done_' ~ item.uid %}
                  {% set ns.rows = ns.rows + [btn] %}
                {% endfor %}
                {% set ns.rows = ns.rows + ['üìú –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ:/toggle_mode_all'] %}
                {% set ns.rows = ns.rows + ['üóë –û—á–∏—Å—Ç–∏—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ:/clear_completed'] %}
                {{ ns.rows }}
              last_msg_id_val: >
                {% if last_message_id_helper.startswith('input_text.') %}
                  {{ states(last_message_id_helper) }}
                {% else %}
                  {{ states(last_message_id_helper) | int(0) }}
                {% endif %}

          - choose:
              - conditions:
                  - condition: template
                    value_template: >
                      {{ last_msg_id_val not in ['', '0', 'unknown', 'unavailable', None] }}
                sequence:
                  - action: telegram_bot.edit_message
                    data:
                      config_entry_id: "{{ bot_config_id }}"
                      chat_id: "{{ trigger.event.data.chat_id }}"
                      message_id: "{{ last_msg_id_val | int }}"
                      message: "{{ header_text_new }}"
                      inline_keyboard: "{{ list_keyboard_new }}"
            default:
              - action: telegram_bot.send_message
                data:
                  config_entry_id: "{{ bot_config_id }}"
                  target: "{{ trigger.event.data.chat_id }}"
                  message: "{{ header_text_new }}"
                  inline_keyboard: "{{ list_keyboard_new }}"
                response_variable: send_resp_new
              
              - variables:
                  new_id: "{{ send_resp_new['message_id'] | default(send_resp_new.message_id) }}"
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ last_message_id_helper.startswith('input_text.') }}"
                    sequence:
                      - action: input_text.set_value
                        target:
                          entity_id: "{{ last_message_id_helper }}"
                        data:
                          value: "{{ new_id }}"
                default:
                  - action: input_number.set_value
                    target:
                      entity_id: "{{ last_message_id_helper }}"
                    data:
                      value: "{{ new_id | int(0) }}"

      # ----------------------------------------------------------------
      # 3. –ö–æ–º–∞–Ω–¥—ã –∏–∑ Reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (—É–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ + –¥–µ–π—Å—Ç–≤–∏–µ)
      # ----------------------------------------------------------------
      - conditions:
          - condition: template
            value_template: >
              {{ trigger.event.event_type == 'telegram_text'
                 and (trigger.event.data.text | default('') | trim) in [
                   'üìú –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫',
                   'üõí –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ',
                   'üìú –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ',
                   'üóë –û—á–∏—Å—Ç–∏—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ',
                   'üî• –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë'
                 ] }}
        sequence:
          - variables:
              text: "{{ trigger.event.data.text | default('') | trim }}"
              chat_id: "{{ trigger.event.data.chat_id | default(0) }}"
              msg_id_raw: >
                {% if trigger.event.data.message is defined and trigger.event.data.message is not none
                      and trigger.event.data.message.message_id is defined %}
                  {{ trigger.event.data.message.message_id }}
                {% elif trigger.event.data.message_id is defined %}
                  {{ trigger.event.data.message_id }}
                {% else %}
                  0
                {% endif %}
              msg_id: "{{ msg_id_raw | int(0) }}"

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ msg_id > 0 }}"
                sequence:
                  - action: telegram_bot.delete_message
                    data:
                      chat_id: "{{ chat_id }}"
                      message_id: "{{ msg_id }}"

          - choose:
              # üìú –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ ‚Äî –ø—Ä–æ—Å—Ç–æ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç /list-–ª–æ–≥–∏–∫—É (–∞–∫—Ç–∏–≤–Ω—ã–µ)
              - conditions:
                  - condition: template
                    value_template: "{{ text == 'üìú –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫' or text == 'üõí –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ' }}"
                sequence:
                  - action: todo.get_items
                    target:
                      entity_id: "{{ todo_entity }}"
                    data:
                      status: ['needs_action']
                    response_variable: todo_resp_cmd

                  - variables:
                      items_cmd: "{{ todo_resp_cmd[todo_entity]['items'] | default([]) }}"
                      header_cmd: >
                        {% if items_cmd | length == 0 %}
                          –°–ø–∏—Å–æ–∫ –ø—É—Å—Ç ü§∑‚Äç‚ôÇÔ∏è
                        {% else %}
                          –í–∞—à —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫:
                        {% endif %}
                      kb_cmd: >
                        {% set ns = namespace(rows=[]) %}
                        {% for item in items_cmd %}
                          {% set btn = '‚úÖ ' ~ item.summary ~ ':/done_' ~ item.uid %}
                          {% set ns.rows = ns.rows + [btn] %}
                        {% endfor %}
                        {% set ns.rows = ns.rows + ['üìú –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ:/toggle_mode_all'] %}
                        {% set ns.rows = ns.rows + ['üóë –û—á–∏—Å—Ç–∏—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ:/clear_completed'] %}
                        {{ ns.rows }}

                  - action: telegram_bot.send_message
                    data:
                      config_entry_id: "{{ bot_config_id }}"
                      target: "{{ trigger.event.data.chat_id }}"
                      message: "{{ header_cmd }}"
                      inline_keyboard: "{{ kb_cmd }}"
                    response_variable: send_resp_cmd

                  - variables:
                      last_msg_id2: "{{ send_resp_cmd['message_id'] | default(send_resp_cmd.message_id) }}"
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ last_message_id_helper.startswith('input_text.') }}"
                        sequence:
                          - action: input_text.set_value
                            target:
                              entity_id: "{{ last_message_id_helper }}"
                            data:
                              value: "{{ last_msg_id2 }}"
                    default:
                      - action: input_number.set_value
                        target:
                          entity_id: "{{ last_message_id_helper }}"
                        data:
                          value: "{{ last_msg_id2 | int(0) }}"

              # üìú –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã
              - conditions:
                  - condition: template
                    value_template: "{{ text == 'üìú –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ' }}"
                sequence:
                  - action: todo.get_items
                    target:
                      entity_id: "{{ todo_entity }}"
                    response_variable: todo_resp_all_cmd
                  - variables:
                      items_all: "{{ todo_resp_all_cmd[todo_entity]['items'] | default([]) }}"
                      header_all: >
                        {% if items_all | length == 0 %}
                          –°–ø–∏—Å–æ–∫ –ø—É—Å—Ç ü§∑‚Äç‚ôÇÔ∏è
                        {% else %}
                          –ò—Å—Ç–æ—Ä–∏—è (–≤—Å–µ):
                        {% endif %}
                      kb_all: >
                        {% set ns = namespace(rows=[]) %}
                        {% for item in items_all %}
                          {% if item.status == 'needs_action' %}
                            {% set btn = '‚úÖ ' ~ item.summary ~ ':/done_' ~ item.uid %}
                          {% else %}
                            {% set btn = '‚òëÔ∏è ' ~ item.summary ~ ':/reopen_' ~ item.uid %}
                          {% endif %}
                          {% set ns.rows = ns.rows + [btn] %}
                        {% endfor %}
                        {% set ns.rows = ns.rows + ['üóë –û—á–∏—Å—Ç–∏—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ:/clear_completed'] %}
                        {{ ns.rows }}

                  - action: telegram_bot.send_message
                    data:
                      config_entry_id: "{{ bot_config_id }}"
                      target: "{{ trigger.event.data.chat_id }}"
                      message: "{{ header_all }}"
                      inline_keyboard: "{{ kb_all }}"

              # üóë –û—á–∏—Å—Ç–∏—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ
              - conditions:
                  - condition: template
                    value_template: "{{ text == 'üóë –û—á–∏—Å—Ç–∏—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ' }}"
                sequence:
                  - action: todo.remove_completed_items
                    target:
                      entity_id: "{{ todo_entity }}"
                  - action: telegram_bot.send_message
                    data:
                      config_entry_id: "{{ bot_config_id }}"
                      target: "{{ trigger.event.data.chat_id }}"
                      message: "‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã —É–¥–∞–ª–µ–Ω—ã."

              # üî• –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë
              - conditions:
                  - condition: template
                    value_template: "{{ text == 'üî• –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë' }}"
                sequence:
                  - action: todo.get_items
                    target:
                      entity_id: "{{ todo_entity }}"
                    response_variable: all_items_cmd
                  - repeat:
                      for_each: "{{ all_items_cmd[todo_entity]['items'] }}"
                      sequence:
                        - action: todo.remove_item
                          target:
                            entity_id: "{{ todo_entity }}"
                          data:
                            item: "{{ repeat.item.uid }}"
                  - action: telegram_bot.send_message
                    data:
                      config_entry_id: "{{ bot_config_id }}"
                      target: "{{ trigger.event.data.chat_id }}"
                      message: "üî• –í–µ—Å—å —Å–ø–∏—Å–æ–∫ –æ—á–∏—â–µ–Ω."

      # ----------------------------------------------------------------
      # 4. Callback (inline-–∫–Ω–æ–ø–∫–∏)
      # ----------------------------------------------------------------
      - conditions:
          - condition: template
            value_template: >
              {{ trigger.event.event_type == 'telegram_callback' }}
        sequence:
          - variables:
              data: "{{ trigger.event.data.data | default('') }}"
              is_done: "{{ data.startswith('/done_') }}"
              is_reopen: "{{ data.startswith('/reopen_') }}"
              is_clear: "{{ data == '/clear_completed' }}"
              is_toggle_active: "{{ data == '/toggle_mode_active' }}"
              is_toggle_all: "{{ data == '/toggle_mode_all' }}"
              
              show_mode: >
                {% if is_toggle_all %}all
                {% elif is_toggle_active %}active
                {% else %}active{% endif %}
              
              current_msg_id: "{{ trigger.event.data.message.message_id }}"
              chat_id: "{{ trigger.event.data.chat_id }}"

          - if:
              - condition: template
                value_template: "{{ is_clear }}"
            then:
              - action: todo.remove_completed_items
                target:
                  entity_id: "{{ todo_entity }}"

          - if:
              - condition: template
                value_template: "{{ is_done }}"
            then:
              - variables:
                  uid: "{{ data.split('_', 1)[1] }}"
              - action: todo.update_item
                target:
                  entity_id: "{{ todo_entity }}"
                data:
                  item: "{{ uid }}"
                  status: "completed"

          - if:
              - condition: template
                value_template: "{{ is_reopen }}"
            then:
              - variables:
                  uid: "{{ data.split('_', 1)[1] }}"
              - action: todo.update_item
                target:
                  entity_id: "{{ todo_entity }}"
                data:
                  item: "{{ uid }}"
                  status: "needs_action"

          - action: todo.get_items
            target:
              entity_id: "{{ todo_entity }}"
            response_variable: todo_resp_cb

          - variables:
              items_raw: "{{ todo_resp_cb[todo_entity]['items'] | default([]) }}"
              items: >
                {% if show_mode == 'active' %}
                  {{ items_raw | selectattr('status', 'eq', 'needs_action') | list }}
                {% else %}
                  {{ items_raw }}
                {% endif %}
              header_text_cb: >
                {% if items | length == 0 %}
                  –°–ø–∏—Å–æ–∫ –ø—É—Å—Ç ü§∑‚Äç‚ôÇÔ∏è
                {% else %}
                  {% if show_mode == 'active' %}–í–∞—à —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫:{% else %}–ò—Å—Ç–æ—Ä–∏—è (–≤—Å–µ):{% endif %}
                {% endif %}
              keyboard_cb: >
                {% set ns = namespace(rows=[]) %}
                {% for item in items %}
                  {% if item.status == 'needs_action' %}
                    {% set btn = '‚úÖ ' ~ item.summary ~ ':/done_' ~ item.uid %}
                    {% set ns.rows = ns.rows + [btn] %}
                  {% else %}
                    {% set btn = '‚òëÔ∏è ' ~ item.summary ~ ':/reopen_' ~ item.uid %}
                    {% set ns.rows = ns.rows + [btn] %}
                  {% endif %}
                {% endfor %}
                {% set toggle_str = '' %}
                {% if show_mode == 'active' %}
                  {% set toggle_str = 'üìú –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ:/toggle_mode_all' %}
                {% else %}
                  {% set toggle_str = 'üõí –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ:/toggle_mode_active' %}
                {% endif %}
                {% set ns.rows = ns.rows + [toggle_str] %}
                {% set ns.rows = ns.rows + ['üóë –û—á–∏—Å—Ç–∏—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ:/clear_completed'] %}
                {{ ns.rows }}

          - action: telegram_bot.edit_message
            data:
              config_entry_id: "{{ bot_config_id }}"
              chat_id: "{{ chat_id }}"
              message_id: "{{ current_msg_id }}"
              message: "{{ header_text_cb }}"
              inline_keyboard: "{{ keyboard_cb }}"

          - action: telegram_bot.answer_callback_query
            data:
              config_entry_id: "{{ bot_config_id }}"
              callback_query_id: "{{ trigger.event.data.id }}"
              message: >
                {% if is_done %}–í—ã–ø–æ–ª–Ω–µ–Ω–æ{% elif is_reopen %}–°–Ω–æ–≤–∞ –∞–∫—Ç–∏–≤–Ω–æ{% elif is_clear %}–°–ø–∏—Å–æ–∫ –æ—á–∏—â–µ–Ω{% else %}–û–±–Ω–æ–≤–ª–µ–Ω–æ{% endif %}
