blueprint:
  name: Telegram To-do List TEST (edit_message only on change)
  description: >
    Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚:
    - edit_message Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¸ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸
    - inline-ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑÑÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
    - /list Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚
    - Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ¸Ğ· UI Home Assistant Ğ¿ÑƒÑˆĞ°Ñ‚ÑÑ Ğ² Telegram
    - HA 2025.12+
  domain: automation

  input:
    todo_entity:
      name: To-do ÑĞ¿Ğ¸ÑĞ¾Ğº
      selector:
        entity:
          domain: todo

    telegram_chat_id:
      name: Telegram chat_id
      selector:
        number:

    bot_config_entry_id:
      name: Config Entry ID Ğ±Ğ¾Ñ‚Ğ°
      selector:
        text:

mode: restart
max_exceeded: silent

variables:
  todo_entity: !input todo_entity
  chat_id: !input telegram_chat_id
  bot_id: !input bot_config_entry_id

trigger:
  # Telegram
  - platform: event
    event_type: telegram_command
  - platform: event
    event_type: telegram_text
  - platform: event
    event_type: telegram_callback

  # ĞĞ°Ğ´Ñ‘Ğ¶Ğ½Ñ‹Ğ¹ Ñ‚Ñ€Ğ¸Ğ³Ğ³ĞµÑ€ Ğ´Ğ»Ñ UI Home Assistant (2025.12+)
  - platform: state
    entity_id: !input todo_entity

condition:
  - condition: template
    value_template: >
      {{ trigger.platform == 'state'
         or trigger.event.data.chat_id | int == chat_id | int }}

action:
  - choose:

      ############################################################
      # Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ ToDo Ğ² UI Home Assistant â†’ Ğ¿Ñ€Ğ¸ÑĞ»Ğ°Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº
      ############################################################
      - conditions:
          - condition: template
            value_template: "{{ trigger.platform == 'state' }}"
        sequence:
          - action: todo.get_items
            target:
              entity_id: "{{ todo_entity }}"
            data:
              status: ['needs_action']
            response_variable: todo_resp

          - variables:
              items: "{{ todo_resp[todo_entity]['items'] | default([]) }}"
              text: >
                {% if items | length == 0 %}
                  ğŸ›’ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº Ğ¿ÑƒÑÑ‚ ğŸ¤·â€â™‚ï¸
                {% else %}
                  ğŸ›’ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½:
                {% endif %}
              keyboard: >
                {% set r = namespace(v=[]) %}
                {% for i in items %}
                  {% set r.v = r.v + [[['âœ… ' ~ i.summary, '/done_' ~ i.uid]]] %}
                {% endfor %}
                {% set r.v = r.v + [[['ğŸ“‚ Ğ’ÑĞµ','/show_all']]] %}
                {% set r.v = r.v + [[['ğŸ—‘ ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ','/clear_completed']]] %}
                {{ r.v }}

          - action: telegram_bot.send_message
            data:
              config_entry_id: "{{ bot_id }}"
              chat_id: "{{ chat_id }}"
              message: "{{ text }}"
              inline_keyboard: "{{ keyboard }}"

      ############################################################
      # /start Ğ¸ /list â€” Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ
      ############################################################
      - conditions:
          - condition: template
            value_template: >
              {{ trigger.event.event_type == 'telegram_command'
                 and trigger.event.data.command in ['/start','/list'] }}
        sequence:
          - action: todo.get_items
            target:
              entity_id: "{{ todo_entity }}"
            data:
              status: ['needs_action']
            response_variable: todo_resp

          - variables:
              items: "{{ todo_resp[todo_entity]['items'] | default([]) }}"
              text: >
                {% if items | length == 0 %}
                  ğŸ›’ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº Ğ¿ÑƒÑÑ‚ ğŸ¤·â€â™‚ï¸
                {% else %}
                  ğŸ›’ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº:
                {% endif %}
              keyboard: >
                {% set r = namespace(v=[]) %}
                {% for i in items %}
                  {% set r.v = r.v + [[['âœ… ' ~ i.summary, '/done_' ~ i.uid]]] %}
                {% endfor %}
                {% set r.v = r.v + [[['ğŸ“‚ Ğ’ÑĞµ','/show_all']]] %}
                {% set r.v = r.v + [[['ğŸ—‘ ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ','/clear_completed']]] %}
                {{ r.v }}

          - action: telegram_bot.send_message
            data:
              config_entry_id: "{{ bot_id }}"
              chat_id: "{{ chat_id }}"
              message: "{{ text }}"
              inline_keyboard: "{{ keyboard }}"

      ############################################################
      # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿ÑƒĞ½ĞºÑ‚Ğ° Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼
      ############################################################
      - conditions:
          - condition: template
            value_template: >
              {{ trigger.event.event_type == 'telegram_text'
                 and not (trigger.event.data.text | trim).startswith('/') }}
        sequence:
          - action: todo.add_item
            target:
              entity_id: "{{ todo_entity }}"
            data:
              item: "{{ trigger.event.data.text | trim }}"

      ############################################################
      # Inline-ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ â€” Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ + edit_message
      ############################################################
      - conditions:
          - condition: template
            value_template: "{{ trigger.event.event_type == 'telegram_callback' }}"
        sequence:
          - variables:
              cb: "{{ trigger.event.data.data }}"
              msg_id: "{{ trigger.event.data.message.message_id }}"

          - if:
              - condition: template
                value_template: "{{ cb.startswith('/done_') }}"
            then:
              - action: todo.update_item
                target:
                  entity_id: "{{ todo_entity }}"
                data:
                  item: "{{ cb.split('_',1)[1] }}"
                  status: completed

          - if:
              - condition: template
                value_template: "{{ cb == '/clear_completed' }}"
            then:
              - action: todo.remove_completed_items
                target:
                  entity_id: "{{ todo_entity }}"

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ cb == '/show_all' }}"
                sequence:
                  - action: todo.get_items
                    target:
                      entity_id: "{{ todo_entity }}"
                    response_variable: todo_resp
              - conditions:
                  - condition: template
                    value_template: "{{ cb != '/show_all' }}"
                sequence:
                  - action: todo.get_items
                    target:
                      entity_id: "{{ todo_entity }}"
                    data:
                      status: ['needs_action']
                    response_variable: todo_resp

          - variables:
              items: "{{ todo_resp[todo_entity]['items'] | default([]) }}"
              text: >
                {% if items | length == 0 %}
                  ğŸ›’ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº Ğ¿ÑƒÑÑ‚ ğŸ¤·â€â™‚ï¸
                {% else %}
                  ğŸ›’ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº:
                {% endif %}
              keyboard: >
                {% set r = namespace(v=[]) %}
                {% for i in items %}
                  {% if i.status == 'needs_action' %}
                    {% set r.v = r.v + [[['âœ… ' ~ i.summary, '/done_' ~ i.uid]]] %}
                  {% else %}
                    {% set r.v = r.v + [[['â˜‘ï¸ ' ~ i.summary, '/noop']]] %}
                  {% endif %}
                {% endfor %}
                {% set r.v = r.v + [[['ğŸ“‚ Ğ’ÑĞµ','/show_all']]] %}
                {% set r.v = r.v + [[['ğŸ—‘ ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ','/clear_completed']]] %}
                {{ r.v }}

          - action: telegram_bot.edit_message
            data:
              config_entry_id: "{{ bot_id }}"
              chat_id: "{{ chat_id }}"
              message_id: "{{ msg_id }}"
              message: "{{ text }}"
              inline_keyboard: "{{ keyboard }}"

          - action: telegram_bot.answer_callback_query
            data:
              config_entry_id: "{{ bot_id }}"
              callback_query_id: "{{ trigger.event.data.id }}"
              message: "Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾"