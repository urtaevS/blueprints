blueprint:
  name: Telegram To-do List TEST
  description: >
    –ë–∞–∑–æ–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç:
    - edit_message —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏
    - inline-–∫–Ω–æ–ø–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
    - /list —Ä–∞–±–æ—Ç–∞–µ—Ç
    - –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π
    - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ –û—á–∏—Å—Ç–∏—Ç—å
    - –≤–æ–∑–≤—Ä–∞—Ç –∫ Active –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏
    - HA 2025.12+
  domain: automation

  input:
    todo_entity:
      name: To-do —Å–ø–∏—Å–æ–∫
      selector:
        entity:
          domain: todo

    telegram_chat_id:
      name: Telegram chat_id
      selector:
        number:

    bot_config_entry_id:
      name: Config Entry ID –±–æ—Ç–∞
      selector:
        text:

mode: restart
max_exceeded: silent

variables:
  todo_entity: !input todo_entity
  chat_id: !input telegram_chat_id
  bot_id: !input bot_config_entry_id

trigger:
  - platform: event
    event_type: telegram_command
  - platform: event
    event_type: telegram_text
  - platform: event
    event_type: telegram_callback

condition:
  - condition: template
    value_template: >
      {{ trigger.event.data.chat_id | int == chat_id | int }}

action:
  - choose:

      ############################################################
      # /start –∏ /list ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –ê–ö–¢–ò–í–ù–´–ï
      ############################################################
      - conditions:
          - condition: template
            value_template: >
              {{ trigger.event.event_type == 'telegram_command'
                 and trigger.event.data.command in ['/start','/list'] }}
        sequence:
          - action: todo.get_items
            target:
              entity_id: "{{ todo_entity }}"
            data:
              status: ['needs_action']
            response_variable: todo_resp

          - variables:
              items: "{{ todo_resp[todo_entity]['items'] | default([]) }}"
              has_completed: false
              text: >
                {% if items | length == 0 %}
                  üõí –°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ –ø—É—Å—Ç ü§∑‚Äç‚ôÇÔ∏è
                {% else %}
                  üõí –°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫:
                {% endif %}
              keyboard: >
                {% set r = namespace(v=[]) %}
                {% for i in items %}
                  {% set r.v = r.v + [[['‚úÖ ' ~ i.summary, '/done_' ~ i.uid]]] %}
                {% endfor %}
                {% set r.v = r.v + [[['üìÇ –í—Å–µ','/show_all']]] %}
                {{ r.v }}

          - action: telegram_bot.send_message
            data:
              config_entry_id: "{{ bot_id }}"
              chat_id: "{{ chat_id }}"
              message: "{{ text }}"
              inline_keyboard: "{{ keyboard }}"

      ############################################################
      # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—É–Ω–∫—Ç–∞ —Ç–µ–∫—Å—Ç–æ–º (–° –ó–ê–©–ò–¢–û–ô –û–¢ –î–£–ë–õ–ï–ô)
      ############################################################
      - conditions:
          - condition: template
            value_template: >
              {{ trigger.event.event_type == 'telegram_text'
                 and not (trigger.event.data.text | trim).startswith('/') }}
        sequence:
          - variables:
              new_item: "{{ trigger.event.data.text | trim }}"

          - action: todo.get_items
            target:
              entity_id: "{{ todo_entity }}"
            response_variable: current

          - variables:
              existing: >
                {{ current[todo_entity]['items']
                   | map(attribute='summary')
                   | map('lower')
                   | list }}
              is_duplicate: "{{ new_item | lower in existing }}"

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ is_duplicate }}"
                sequence:
                  - action: telegram_bot.send_message
                    data:
                      config_entry_id: "{{ bot_id }}"
                      chat_id: "{{ chat_id }}"
                      message: "‚ö†Ô∏è –ü—É–Ω–∫—Ç ¬´{{ new_item }}¬ª —É–∂–µ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ"

              - conditions:
                  - condition: template
                    value_template: "{{ not is_duplicate }}"
                sequence:
                  - action: todo.add_item
                    target:
                      entity_id: "{{ todo_entity }}"
                    data:
                      item: "{{ new_item }}"

                  - action: todo.get_items
                    target:
                      entity_id: "{{ todo_entity }}"
                    data:
                      status: ['needs_action']
                    response_variable: todo_resp

                  - variables:
                      items: "{{ todo_resp[todo_entity]['items'] }}"
                      text: "üõí –°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫:"
                      keyboard: >
                        {% set r = namespace(v=[]) %}
                        {% for i in items %}
                          {% set r.v = r.v + [[['‚úÖ ' ~ i.summary, '/done_' ~ i.uid]]] %}
                        {% endfor %}
                        {% set r.v = r.v + [[['üìÇ –í—Å–µ','/show_all']]] %}
                        {{ r.v }}

                  - action: telegram_bot.send_message
                    data:
                      config_entry_id: "{{ bot_id }}"
                      chat_id: "{{ chat_id }}"
                      message: "{{ text }}"
                      inline_keyboard: "{{ keyboard }}"

      ############################################################
      # Inline-–∫–Ω–æ–ø–∫–∏ ‚Äî DONE / CLEAR / SHOW ALL
      ############################################################
      - conditions:
          - condition: template
            value_template: "{{ trigger.event.event_type == 'telegram_callback' }}"
        sequence:
          - variables:
              cb: "{{ trigger.event.data.data }}"
              msg_id: "{{ trigger.event.data.message.message_id }}"
              mode: >
                {% if cb == '/show_all' %}all{% else %}active{% endif %}

          # DONE
          - if:
              - condition: template
                value_template: "{{ cb.startswith('/done_') }}"
            then:
              - action: todo.update_item
                target:
                  entity_id: "{{ todo_entity }}"
                data:
                  item: "{{ cb.split('_',1)[1] }}"
                  status: completed

          # CLEAR ‚Üí –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ active
          - if:
              - condition: template
                value_template: "{{ cb == '/clear_completed' }}"
            then:
              - action: todo.remove_completed_items
                target:
                  entity_id: "{{ todo_entity }}"
              - variables:
                  mode: active

          # –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ mode == 'all' }}"
                sequence:
                  - action: todo.get_items
                    target:
                      entity_id: "{{ todo_entity }}"
                    response_variable: todo_resp
              - conditions:
                  - condition: template
                    value_template: "{{ mode == 'active' }}"
                sequence:
                  - action: todo.get_items
                    target:
                      entity_id: "{{ todo_entity }}"
                    data:
                      status: ['needs_action']
                    response_variable: todo_resp

          - variables:
              items: "{{ todo_resp[todo_entity]['items'] | default([]) }}"
              has_completed: >
                {{ todo_resp[todo_entity]['items']
                   | selectattr('status','eq','completed')
                   | list | length > 0 }}
              text: >
                {% if items | length == 0 %}
                  üõí –°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ –ø—É—Å—Ç ü§∑‚Äç‚ôÇÔ∏è
                {% else %}
                  üõí –°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫:
                {% endif %}
              keyboard: >
                {% set r = namespace(v=[]) %}
                {% for i in items %}
                  {% if i.status == 'needs_action' %}
                    {% set r.v = r.v + [[['‚úÖ ' ~ i.summary, '/done_' ~ i.uid]]] %}
                  {% else %}
                    {% set r.v = r.v + [[['‚òëÔ∏è ' ~ i.summary, '/noop']]] %}
                  {% endif %}
                {% endfor %}
                {% if mode == 'active' %}
                  {% set r.v = r.v + [[['üìÇ –í—Å–µ','/show_all']]] %}
                {% else %}
                  {% set r.v = r.v + [[['‚ñ∂ –ê–∫—Ç–∏–≤–Ω—ã–µ','/show_active']]] %}
                {% endif %}
                {% if has_completed %}
                  {% set r.v = r.v + [[['üóë –û—á–∏—Å—Ç–∏—Ç—å','/clear_completed']]] %}
                {% endif %}
                {{ r.v }}

          - action: telegram_bot.edit_message
            data:
              config_entry_id: "{{ bot_id }}"
              chat_id: "{{ chat_id }}"
              message_id: "{{ msg_id }}"
              message: "{{ text }}"
              inline_keyboard: "{{ keyboard }}"

          - action: telegram_bot.answer_callback_query
            data:
              config_entry_id: "{{ bot_id }}"
              callback_query_id: "{{ trigger.event.data.id }}"
              message: >
                {% if cb == '/clear_completed' %}
                  üóë –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã —É–¥–∞–ª–µ–Ω—ã
                {% elif cb == '/show_all' %}
                  üìÇ –ü–æ–∫–∞–∑–∞–Ω—ã –≤—Å–µ –ø—É–Ω–∫—Ç—ã
                {% elif cb == '/show_active' %}
                  ‚ñ∂ –ü–æ–∫–∞–∑–∞–Ω—ã –∞–∫—Ç–∏–≤–Ω—ã–µ
                {% elif cb.startswith('/done_') %}
                  ‚úÖ –ü—É–Ω–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω
                {% else %}
                  –ì–æ—Ç–æ–≤–æ
                {% endif %}