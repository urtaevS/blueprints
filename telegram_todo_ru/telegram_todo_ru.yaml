blueprint:
  name: Telegram To-do List
  description: >
    Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚:
    - edit_message Ğ´Ğ»Ñ inline-ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº
    - Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Active / All (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ completed)
    - Ğ´Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ°Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ° ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ
    - Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ Ğ´ÑƒĞ±Ğ»ĞµĞ¹
    - reopen Ğ¿Ğ¾ â˜‘ï¸
    - Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· "," Ğ¸ "."
    - HA 2025.12+
  domain: automation

  input:
    todo_entity:
      name: To-do ÑĞ¿Ğ¸ÑĞ¾Ğº
      selector:
        entity:
          domain: todo

    telegram_chat_id:
      name: Telegram chat_id
      selector:
        number:

    bot_config_entry_id:
      name: Config Entry ID Ğ±Ğ¾Ñ‚Ğ°
      selector:
        text:

mode: restart
max_exceeded: silent

variables:
  todo_entity: !input todo_entity
  chat_id: !input telegram_chat_id
  bot_id: !input bot_config_entry_id
trigger:
  - platform: event
    event_type: telegram_command
  - platform: event
    event_type: telegram_text
  - platform: event
    event_type: telegram_callback

condition:
  - condition: template
    value_template: >
      {{ trigger.event.data.chat_id | int == chat_id | int }}

action:
  - choose:

      ############################################################
      # /start Ğ¸ /list â€” Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ
      ############################################################
      - conditions:
          - condition: template
            value_template: >
              {{ trigger.event.event_type == 'telegram_command'
                 and trigger.event.data.command in ['/start','/list'] }}
        sequence:
          - action: todo.get_items
            target:
              entity_id: "{{ todo_entity }}"
            response_variable: todo_resp

          - variables:
              items: >
                {{ todo_resp[todo_entity]['items']
                   | selectattr('status','eq','needs_action')
                   | list }}
              has_completed: >
                {{ todo_resp[todo_entity]['items']
                   | selectattr('status','eq','completed')
                   | list | length > 0 }}
              text: >
                {% if items | length == 0 %}
                  ğŸ›’ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº Ğ¿ÑƒÑÑ‚ ğŸ¤·â€â™‚ï¸
                {% else %}
                  ğŸ›’ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº:
                {% endif %}
              keyboard: >
                {% set r = namespace(v=[]) %}
                {% for i in items %}
                  {% set r.v = r.v + [[['âœ… ' ~ i.summary, '/done_' ~ i.uid]]] %}
                {% endfor %}
                {% if has_completed %}
                  {% set r.v = r.v + [[['ğŸ“‚ Ğ’ÑĞµ','/show_all']]] %}
                {% endif %}
                {{ r.v }}

          - action: telegram_bot.send_message
            data:
              config_entry_id: "{{ bot_id }}"
              target: "{{ chat_id }}"
              message: "{{ text }}"
              inline_keyboard: "{{ keyboard }}"
              keyboard:
                - "ğŸ“‹ ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº"
                - "ğŸ—‘ ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ñ‹Ğµ"
              resize_keyboard: true
              one_time_keyboard: false


      ############################################################
      # REPLY: ğŸ“‹ ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº
      ############################################################
      - conditions:
          - condition: template
            value_template: >
              {{ trigger.event.event_type == 'telegram_text'
                 and trigger.event.data.text == 'ğŸ“‹ ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº' }}
        sequence:
          - action: todo.get_items
            target:
              entity_id: "{{ todo_entity }}"
            response_variable: todo_resp

          - variables:
              items: >
                {{ todo_resp[todo_entity]['items']
                   | selectattr('status','eq','needs_action')
                   | list }}
              has_completed: >
                {{ todo_resp[todo_entity]['items']
                   | selectattr('status','eq','completed')
                   | list | length > 0 }}
              text: >
                {% if items | length == 0 %}
                  ğŸ›’ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº Ğ¿ÑƒÑÑ‚ ğŸ¤·â€â™‚ï¸
                {% else %}
                  ğŸ›’ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº:
                {% endif %}
              keyboard: >
                {% set r = namespace(v=[]) %}
                {% for i in items %}
                  {% set r.v = r.v + [[['âœ… ' ~ i.summary, '/done_' ~ i.uid]]] %}
                {% endfor %}
                {% if has_completed %}
                  {% set r.v = r.v + [[['ğŸ“‚ Ğ’ÑĞµ','/show_all']]] %}
                {% endif %}
                {{ r.v }}

          - action: telegram_bot.send_message
            data:
              config_entry_id: "{{ bot_id }}"
              target: "{{ chat_id }}"
              message: "{{ text }}"
              inline_keyboard: "{{ keyboard }}"

      ############################################################
      # REPLY: ğŸ—‘ ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ñ‹Ğµ
      ############################################################
      - conditions:
          - condition: template
            value_template: >
              {{ trigger.event.event_type == 'telegram_text'
                 and trigger.event.data.text == 'ğŸ—‘ ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ñ‹Ğµ' }}
        sequence:
          - action: todo.remove_completed_items
            target:
              entity_id: "{{ todo_entity }}"

          - action: todo.get_items
            target:
              entity_id: "{{ todo_entity }}"
            response_variable: todo_resp

          - variables:
              items: >
                {{ todo_resp[todo_entity]['items']
                   | selectattr('status','eq','needs_action')
                   | list }}
              text: >
                {% if items | length == 0 %}
                  ğŸ›’ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº Ğ¿ÑƒÑÑ‚ ğŸ¤·â€â™‚ï¸
                {% else %}
                  ğŸ›’ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº:
                {% endif %}
              keyboard: >
                {% set r = namespace(v=[]) %}
                {% for i in items %}
                  {% set r.v = r.v + [[['âœ… ' ~ i.summary, '/done_' ~ i.uid]]] %}
                {% endfor %}
                {{ r.v }}

          - action: telegram_bot.send_message
            data:
              config_entry_id: "{{ bot_id }}"
              target: "{{ chat_id }}"
              message: "{{ text }}"
              inline_keyboard: "{{ keyboard }}"

      ############################################################
      # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿ÑƒĞ½ĞºÑ‚Ğ° Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼ (ĞœĞ£Ğ›Ğ¬Ğ¢Ğ˜ + Ğ—ĞĞ©Ğ˜Ğ¢Ğ ĞĞ¢ Ğ”Ğ£Ğ‘Ğ›Ğ•Ğ™)
      ############################################################
      - conditions:
          - condition: template
            value_template: >
              {{ trigger.event.event_type == 'telegram_text'
                 and trigger.event.data.text not in [
                   'ğŸ“‹ ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº',
                   'ğŸ—‘ ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ñ‹Ğµ'
                 ]
                 and not (trigger.event.data.text | trim).startswith('/') }}
        sequence:
          - variables:
              raw_text: "{{ trigger.event.data.text }}"
              candidates: >
                {% set parts = raw_text.replace('.', ',').split(',') %}
                {{ parts | map('trim') | reject('equalto','') | list }}

          - action: todo.get_items
            target:
              entity_id: "{{ todo_entity }}"
            response_variable: current

          - repeat:
              for_each: "{{ candidates }}"
              sequence:
                - variables:
                    raw: "{{ repeat.item }}"
                    new_item: "{{ repeat.item | lower | replace(' ','') }}"

                - variables:
                    active_items: >
                      {{ current[todo_entity]['items']
                         | selectattr('status','eq','needs_action')
                         | list }}
                    completed_items: >
                      {{ current[todo_entity]['items']
                         | selectattr('status','eq','completed')
                         | list }}

                    active_norm: >
                      {{ active_items
                         | map(attribute='summary')
                         | map('lower')
                         | map('replace',' ','')
                         | list }}

                    completed_norm: >
                      {{ completed_items
                         | map(attribute='summary')
                         | map('lower')
                         | map('replace',' ','')
                         | list }}

                - choose:
                    - conditions:
                        - condition: template
                          value_template: "{{ new_item in active_norm }}"
                      sequence:
                        - action: telegram_bot.send_message
                          data:
                            config_entry_id: "{{ bot_id }}"
                            target: "{{ chat_id }}"
                            message: "âš ï¸ ĞŸÑƒĞ½ĞºÑ‚ Â«{{ raw }}Â» ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ Ğ² ÑĞ¿Ğ¸ÑĞºĞµ"

                    - conditions:
                        - condition: template
                          value_template: "{{ new_item in completed_norm }}"
                      sequence:
                        - variables:
                            idx: "{{ completed_norm.index(new_item) }}"
                            uid: "{{ completed_items[idx].uid }}"
                        - action: todo.update_item
                          target:
                            entity_id: "{{ todo_entity }}"
                          data:
                            item: "{{ uid }}"
                            status: needs_action

                    - conditions:
                        - condition: template
                          value_template: >
                            {{ new_item not in active_norm
                               and new_item not in completed_norm }}
                      sequence:
                        - action: todo.add_item
                          target:
                            entity_id: "{{ todo_entity }}"
                          data:
                            item: "{{ raw }}"

          - action: todo.get_items
            target:
              entity_id: "{{ todo_entity }}"
            response_variable: todo_resp

          - variables:
              items: >
                {{ todo_resp[todo_entity]['items']
                   | selectattr('status','eq','needs_action')
                   | list }}
              has_completed: >
                {{ todo_resp[todo_entity]['items']
                   | selectattr('status','eq','completed')
                   | list | length > 0 }}
              text: >
                {% if items | length == 0 %}
                  ğŸ›’ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº Ğ¿ÑƒÑÑ‚ ğŸ¤·â€â™‚ï¸
                {% else %}
                  ğŸ›’ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº:
                {% endif %}
              keyboard: >
                {% set r = namespace(v=[]) %}
                {% for i in items %}
                  {% set r.v = r.v + [[['âœ… ' ~ i.summary, '/done_' ~ i.uid]]] %}
                {% endfor %}
                {% if has_completed %}
                  {% set r.v = r.v + [[['ğŸ“‚ Ğ’ÑĞµ','/show_all']]] %}
                {% endif %}
                {{ r.v }}

          - action: telegram_bot.send_message
            data:
              config_entry_id: "{{ bot_id }}"
              target: "{{ chat_id }}"
              message: "{{ text }}"
              inline_keyboard: "{{ keyboard }}"

      ############################################################
      # Inline-ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ â€” UI (edit_message)
      ############################################################
      - conditions:
          - condition: template
            value_template: "{{ trigger.event.event_type == 'telegram_callback' }}"
        sequence:
          - variables:
              cb: "{{ trigger.event.data.data }}"
              msg_id: "{{ trigger.event.data.message.message_id }}"

          - if:
              - condition: template
                value_template: "{{ cb.startswith('/done_') }}"
            then:
              - action: todo.update_item
                target:
                  entity_id: "{{ todo_entity }}"
                data:
                  item: "{{ cb.split('_',1)[1] }}"
                  status: completed

          - if:
              - condition: template
                value_template: "{{ cb.startswith('/reopen_') }}"
            then:
              - action: todo.update_item
                target:
                  entity_id: "{{ todo_entity }}"
                data:
                  item: "{{ cb.split('_',1)[1] }}"
                  status: needs_action

          - if:
              - condition: template
                value_template: "{{ cb == '/clear_completed' }}"
            then:
              - action: todo.remove_completed_items
                target:
                  entity_id: "{{ todo_entity }}"

          - action: todo.get_items
            target:
              entity_id: "{{ todo_entity }}"
            response_variable: todo_resp

          - variables:
              items_all: "{{ todo_resp[todo_entity]['items'] | default([]) }}"
              has_completed: >
                {{ items_all
                   | selectattr('status','eq','completed')
                   | list | length > 0 }}
              mode: >
                {% if cb == '/show_all' %}all{% else %}active{% endif %}
              items: >
                {% if mode == 'all' %}
                  {{ items_all }}
                {% else %}
                  {{ items_all
                     | selectattr('status','eq','needs_action')
                     | list }}
                {% endif %}
              text: >
                {% if items | length == 0 %}
                  ğŸ›’ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº Ğ¿ÑƒÑÑ‚ ğŸ¤·â€â™‚ï¸
                {% else %}
                  ğŸ›’ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº:
                {% endif %}
              keyboard: >
                {% set r = namespace(v=[]) %}
                {% for i in items %}
                  {% if i.status == 'needs_action' %}
                    {% set r.v = r.v + [[['âœ… ' ~ i.summary, '/done_' ~ i.uid]]] %}
                  {% else %}
                    {% set r.v = r.v + [[['â˜‘ï¸ ' ~ i.summary, '/reopen_' ~ i.uid]]] %}
                  {% endif %}
                {% endfor %}
                {% if has_completed %}
                  {% if mode == 'active' %}
                    {% set r.v = r.v + [[['ğŸ“‚ Ğ’ÑĞµ','/show_all']]] %}
                  {% else %}
                    {% set r.v = r.v + [[['ğŸ›’ ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ','/show_active']]] %}
                  {% endif %}
                  {% set r.v = r.v + [[['ğŸ—‘ ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ','/clear_completed']]] %}
                {% endif %}
                {{ r.v }}

          - action: telegram_bot.edit_message
            data:
              config_entry_id: "{{ bot_id }}"
              chat_id: "{{ chat_id }}"
              message_id: "{{ msg_id }}"
              message: "{{ text }}"
              inline_keyboard: "{{ keyboard }}"

          - action: telegram_bot.answer_callback_query
            data:
              config_entry_id: "{{ bot_id }}"
              callback_query_id: "{{ trigger.event.data.id }}"
              message: "Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾"

      ############################################################
      # REPLY: ğŸ“‹ ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº
      ############################################################
      - conditions:
          - condition: template
            value_template: >
              {{ trigger.event.event_type == 'telegram_text'
                 and trigger.event.data.text == 'ğŸ“‹ ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº' }}
        sequence:
          - action: todo.get_items
            target:
              entity_id: "{{ todo_entity }}"
            response_variable: todo_resp

          - variables:
              items: >
                {{ todo_resp[todo_entity]['items']
                   | selectattr('status','eq','needs_action')
                   | list }}
              has_completed: >
                {{ todo_resp[todo_entity]['items']
                   | selectattr('status','eq','completed')
                   | list | length > 0 }}
              text: >
                {% if items | length == 0 %}
                  ğŸ›’ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº Ğ¿ÑƒÑÑ‚ ğŸ¤·â€â™‚ï¸
                {% else %}
                  ğŸ›’ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº:
                {% endif %}
              keyboard: >
                {% set r = namespace(v=[]) %}
                {% for i in items %}
                  {% set r.v = r.v + [[['âœ… ' ~ i.summary, '/done_' ~ i.uid]]] %}
                {% endfor %}
                {% if has_completed %}
                  {% set r.v = r.v + [[['ğŸ“‚ Ğ’ÑĞµ','/show_all']]] %}
                {% endif %}
                {{ r.v }}

          - action: telegram_bot.send_message
            data:
              config_entry_id: "{{ bot_id }}"
              chat_id: "{{ chat_id }}"
              message: "{{ text }}"
              inline_keyboard: "{{ keyboard }}"

      ############################################################
      # REPLY: ğŸ—‘ ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ñ‹Ğµ
      ############################################################
      - conditions:
          - condition: template
            value_template: >
              {{ trigger.event.event_type == 'telegram_text'
                 and trigger.event.data.text == 'ğŸ—‘ ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ñ‹Ğµ' }}
        sequence:
          - action: todo.remove_completed_items
            target:
              entity_id: "{{ todo_entity }}"

          - action: todo.get_items
            target:
              entity_id: "{{ todo_entity }}"
            response_variable: todo_resp

          - variables:
              items: >
                {{ todo_resp[todo_entity]['items']
                   | selectattr('status','eq','needs_action')
                   | list }}
              text: >
                {% if items | length == 0 %}
                  ğŸ›’ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº Ğ¿ÑƒÑÑ‚ ğŸ¤·â€â™‚ï¸
                {% else %}
                  ğŸ›’ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº:
                {% endif %}
              keyboard: >
                {% set r = namespace(v=[]) %}
                {% for i in items %}
                  {% set r.v = r.v + [[['âœ… ' ~ i.summary, '/done_' ~ i.uid]]] %}
                {% endfor %}
                {{ r.v }}

          - action: telegram_bot.send_message
            data:
              config_entry_id: "{{ bot_id }}"
              chat_id: "{{ chat_id }}"
              message: "{{ text }}"
              inline_keyboard: "{{ keyboard }}"

      ############################################################
      # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿ÑƒĞ½ĞºÑ‚Ğ° Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼ (ĞœĞ£Ğ›Ğ¬Ğ¢Ğ˜ + Ğ—ĞĞ©Ğ˜Ğ¢Ğ ĞĞ¢ Ğ”Ğ£Ğ‘Ğ›Ğ•Ğ™)
      ############################################################
      - conditions:
          - condition: template
            value_template: >
              {{ trigger.event.event_type == 'telegram_text'
                 and trigger.event.data.text not in [
                   'ğŸ“‹ ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº',
                   'ğŸ—‘ ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ñ‹Ğµ'
                 ]
                 and not (trigger.event.data.text | trim).startswith('/') }}
        sequence:
          - variables:
              raw_text: "{{ trigger.event.data.text }}"
              candidates: >
                {% set parts = raw_text.replace('.', ',').split(',') %}
                {{ parts | map('trim') | reject('equalto','') | list }}

          - action: todo.get_items
            target:
              entity_id: "{{ todo_entity }}"
            response_variable: current

          - repeat:
              for_each: "{{ candidates }}"
              sequence:
                - variables:
                    raw: "{{ repeat.item }}"
                    new_item: "{{ repeat.item | lower | replace(' ','') }}"

                - variables:
                    active_items: >
                      {{ current[todo_entity]['items']
                         | selectattr('status','eq','needs_action')
                         | list }}
                    completed_items: >
                      {{ current[todo_entity]['items']
                         | selectattr('status','eq','completed')
                         | list }}

                    active_norm: >
                      {{ active_items
                         | map(attribute='summary')
                         | map('lower')
                         | map('replace',' ','')
                         | list }}

                    completed_norm: >
                      {{ completed_items
                         | map(attribute='summary')
                         | map('lower')
                         | map('replace',' ','')
                         | list }}

                - choose:
                    - conditions:
                        - condition: template
                          value_template: "{{ new_item in active_norm }}"
                      sequence:
                        - action: telegram_bot.send_message
                          data:
                            config_entry_id: "{{ bot_id }}"
                            chat_id: "{{ chat_id }}"
                            message: "âš ï¸ ĞŸÑƒĞ½ĞºÑ‚ Â«{{ raw }}Â» ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ Ğ² ÑĞ¿Ğ¸ÑĞºĞµ"

                    - conditions:
                        - condition: template
                          value_template: "{{ new_item in completed_norm }}"
                      sequence:
                        - variables:
                            idx: "{{ completed_norm.index(new_item) }}"
                            uid: "{{ completed_items[idx].uid }}"
                        - action: todo.update_item
                          target:
                            entity_id: "{{ todo_entity }}"
                          data:
                            item: "{{ uid }}"
                            status: needs_action

                    - conditions:
                        - condition: template
                          value_template: >
                            {{ new_item not in active_norm
                               and new_item not in completed_norm }}
                      sequence:
                        - action: todo.add_item
                          target:
                            entity_id: "{{ todo_entity }}"
                          data:
                            item: "{{ raw }}"

          - action: todo.get_items
            target:
              entity_id: "{{ todo_entity }}"
            response_variable: todo_resp

          - variables:
              items: >
                {{ todo_resp[todo_entity]['items']
                   | selectattr('status','eq','needs_action')
                   | list }}
              has_completed: >
                {{ todo_resp[todo_entity]['items']
                   | selectattr('status','eq','completed')
                   | list | length > 0 }}
              text: >
                {% if items | length == 0 %}
                  ğŸ›’ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº Ğ¿ÑƒÑÑ‚ ğŸ¤·â€â™‚ï¸
                {% else %}
                  ğŸ›’ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº:
                {% endif %}
              keyboard: >
                {% set r = namespace(v=[]) %}
                {% for i in items %}
                  {% set r.v = r.v + [[['âœ… ' ~ i.summary, '/done_' ~ i.uid]]] %}
                {% endfor %}
                {% if has_completed %}
                  {% set r.v = r.v + [[['ğŸ“‚ Ğ’ÑĞµ','/show_all']]] %}
                {% endif %}
                {{ r.v }}

          - action: telegram_bot.send_message
            data:
              config_entry_id: "{{ bot_id }}"
              chat_id: "{{ chat_id }}"
              message: "{{ text }}"
              inline_keyboard: "{{ keyboard }}"

      ############################################################
      # Inline-ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ â€” UI (edit_message)
      ############################################################
      - conditions:
          - condition: template
            value_template: "{{ trigger.event.event_type == 'telegram_callback' }}"
        sequence:
          - variables:
              cb: "{{ trigger.event.data.data }}"
              msg_id: "{{ trigger.event.data.message.message_id }}"

          - if:
              - condition: template
                value_template: "{{ cb.startswith('/done_') }}"
            then:
              - action: todo.update_item
                target:
                  entity_id: "{{ todo_entity }}"
                data:
                  item: "{{ cb.split('_',1)[1] }}"
                  status: completed

          - if:
              - condition: template
                value_template: "{{ cb.startswith('/reopen_') }}"
            then:
              - action: todo.update_item
                target:
                  entity_id: "{{ todo_entity }}"
                data:
                  item: "{{ cb.split('_',1)[1] }}"
                  status: needs_action

          - if:
              - condition: template
                value_template: "{{ cb == '/clear_completed' }}"
            then:
              - action: todo.remove_completed_items
                target:
                  entity_id: "{{ todo_entity }}"

          - action: todo.get_items
            target:
              entity_id: "{{ todo_entity }}"
            response_variable: todo_resp

          - variables:
              items_all: "{{ todo_resp[todo_entity]['items'] | default([]) }}"
              has_completed: >
                {{ items_all
                   | selectattr('status','eq','completed')
                   | list | length > 0 }}
              mode: >
                {% if cb == '/show_all' %}all{% else %}active{% endif %}
              items: >
                {% if mode == 'all' %}
                  {{ items_all }}
                {% else %}
                  {{ items_all
                     | selectattr('status','eq','needs_action')
                     | list }}
                {% endif %}
              text: >
                {% if items | length == 0 %}
                  ğŸ›’ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº Ğ¿ÑƒÑÑ‚ ğŸ¤·â€â™‚ï¸
                {% else %}
                  ğŸ›’ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº:
                {% endif %}
              keyboard: >
                {% set r = namespace(v=[]) %}
                {% for i in items %}
                  {% if i.status == 'needs_action' %}
                    {% set r.v = r.v + [[['âœ… ' ~ i.summary, '/done_' ~ i.uid]]] %}
                  {% else %}
                    {% set r.v = r.v + [[['â˜‘ï¸ ' ~ i.summary, '/reopen_' ~ i.uid]]] %}
                  {% endif %}
                {% endfor %}
                {% if has_completed %}
                  {% if mode == 'active' %}
                    {% set r.v = r.v + [[['ğŸ“‚ Ğ’ÑĞµ','/show_all']]] %}
                  {% else %}
                    {% set r.v = r.v + [[['ğŸ›’ ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ','/show_active']]] %}
                  {% endif %}
                  {% set r.v = r.v + [[['ğŸ—‘ ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ','/clear_completed']]] %}
                {% endif %}
                {{ r.v }}

          - action: telegram_bot.edit_message
            data:
              config_entry_id: "{{ bot_id }}"
              chat_id: "{{ chat_id }}"
              message_id: "{{ msg_id }}"
              message: "{{ text }}"
              inline_keyboard: "{{ keyboard }}"

          - action: telegram_bot.answer_callback_query
            data:
              config_entry_id: "{{ bot_id }}"
              callback_query_id: "{{ trigger.event.data.id }}"
              message: "Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾"
